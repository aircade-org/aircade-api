# Railway.app Deployment - Setup Summary

## ‚úÖ What's Been Configured

AirCade API is fully configured for Railway.app deployment.
Here's what has been set up:

### üìÅ Configuration Files

1. **`railway.toml`** - Railway deployment configuration
    - Build command: `cargo build --release`
    - Start command: `./target/release/aircade-api`
    - Health check endpoint: `/health`
    - Auto-restart policy configured

2. **`Dockerfile`** - Multi-stage Docker build (optional optimization)
    - Stage 1: Build with Rust 1.83
    - Stage 2: Minimal runtime with Debian Bookworm
    - Non-root user for security
    - Health check included

3. **`.dockerignore`** - Optimized Docker build context
    - Excludes unnecessary files for faster builds

4. **`.env.example`** - Updated with Railway-specific variables
    - Production-ready environment configuration
    - Railway auto-provided variables documented
    - Security and CORS configuration templates

### üìö Documentation

1. **`docs/railway-deployment.md`** - Comprehensive deployment guide
    - Prerequisites and setup
    - Database configuration
    - Environment variables
    - Deployment process
    - Monitoring and logs
    - Custom domains
    - CI/CD integration
    - Troubleshooting

2. **`docs/RAILWAY_QUICK_START.md`** - 5-minute quick start guide
    - One-click deploy via dashboard
    - CLI deployment
    - Automated setup scripts
    - Common troubleshooting

### üîß Automation Scripts

1. **`scripts/railway-setup.sh`** - Linux/macOS automated setup
    - Auto-installs Railway CLI
    - Initializes project
    - Adds PostgreSQL
    - Sets environment variables

2. **`scripts/railway-setup.bat`** - Windows automated setup
    - Windows-compatible setup script
    - Same functionality as shell script

### üöÄ CI/CD Pipeline

1. **`.github/workflows/railway-deploy.yml`** - GitHub Actions workflow
    - Runs on push to `main` or `staging`
    - Quality checks (format, lint, test, build)
    - Automated deployment to Railway
    - Health check verification
    - Separate staging environment support

## üéØ Quick Start Options

### Option 1: Dashboard (No CLI required)

1. Go to [railway.app](https://railway.app)
2. Create new project ‚Üí Deploy from GitHub
3. Select `aircade-org/aircade-api`
4. Add PostgreSQL database
5. Set environment variables (see below)

### Option 2: CLI (Recommended)

```bash
# Install CLI
npm install -g @railway/cli

# Run automated setup
./scripts/railway-setup.sh  # Linux/macOS
# OR
.\scripts\railway-setup.bat  # Windows
```

### Option 3: Automated (GitHub Actions)

1. Get Railway token: `railway whoami --token`
2. Add to GitHub Secrets as `RAILWAY_TOKEN`
3. Push to `main` branch - auto-deploys!

## üîê Required Environment Variables

Set these in Railway Dashboard ‚Üí Variables tab:

```bash
ENVIRONMENT=production
SERVER_HOST=0.0.0.0
LOG_LEVEL=info
RUST_LOG=aircade_api=info,tower_http=info,axum=info
```

**Auto-provided by Railway:**

- `DATABASE_URL` (from PostgreSQL service)
- `PORT` (dynamic port assignment)
- `RAILWAY_ENVIRONMENT`
- `RAILWAY_PROJECT_ID`
- `RAILWAY_SERVICE_ID`

## üìã Pre-Deployment Checklist

Before deploying, ensure:

- [ ] `/health` endpoint is implemented in your API
- [ ] Server binds to `0.0.0.0` (not `127.0.0.1`)
- [ ] Server uses `$PORT` environment variable
- [ ] Database migrations are ready
- [ ] `.env` file is in `.gitignore` (never commit secrets!)
- [ ] All tests pass: `cargo test`
- [ ] Linter passes: `cargo clippy`

## üîç Health Endpoint Implementation

Add this to your API (required for Railway health checks):

```rust
use axum::{Router, routing::get, Json};
use serde_json::json;

async fn health_check() -> Json<serde_json::Value> {
    Json(json!({
        "status": "healthy",
        "timestamp": chrono::Utc::now().to_rfc3339(),
        "version": env!("CARGO_PKG_VERSION")
    }))
}

pub fn create_router() -> Router {
    Router::new()
        .route("/health", get(health_check))
    // ... other routes
}
```

## üåê Server Configuration

Ensure your server binds correctly for Railway:

```rust
use std::env;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Load environment variables
    dotenvy::dotenv().ok();

    // Get port from Railway or default to 3000
    let port = env::var("PORT").unwrap_or_else(|_| "3000".to_string());

    // IMPORTANT: Bind to 0.0.0.0, not 127.0.0.1
    let addr = format!("0.0.0.0:{}", port);

    // Create listener
    let listener = tokio::net::TcpListener::bind(&addr).await?;

    println!("üöÄ Server listening on {}", addr);

    // Serve app
    axum::serve(listener, app).await?;

    Ok(())
}
```

## üóÑÔ∏è Database Migrations

### Option 1: Run via CLI

```bash
railway run sea-orm-cli migrate up
```

### Option 2: Run on Startup

```rust
use sea_orm_migration::MigratorTrait;

// In main.rs
let db = Database::connect( & database_url).await?;
migration::Migrator::up( & db, None).await?;
```

### Option 3: Add to Build Command

```toml
# railway.toml
[build]
buildCommand = "cargo build --release && sea-orm-cli migrate up"
```

## üìä Monitoring

### View Logs

```bash
# Real-time logs
railway logs --follow

# Last 100 lines
railway logs
```

### Check Metrics

- Railway Dashboard ‚Üí Your Service ‚Üí "Metrics" tab
- Monitor CPU, Memory, Network, and Requests

### Health Check

```bash
# Replace with your Railway URL
curl https://your-app.railway.app/health
```

## üö® Troubleshooting

### Build Fails (Out of Memory)

Reduce optimization in `Cargo.toml`:

```toml
[profile.release]
opt-level = 2
lto = "thin"
codegen-units = 4
```

### Health Check Fails

- Verify `/health` endpoint exists
- Check server binds to `0.0.0.0:$PORT`
- Review logs: `railway logs`

### Database Connection Fails

```bash
# Verify DATABASE_URL is set
railway variables | grep DATABASE_URL

# Check PostgreSQL service is running
railway status
```

### Slow Cold Starts (Free Tier)

- Upgrade to Starter plan ($5/month) to eliminate cold starts
- Or accept 10-minute cold start on free tier

## üí∞ Cost Estimate

| Tier        | Cost      | Features                           |
|-------------|-----------|------------------------------------|
| **Free**    | $0        | $5 usage credit/month, cold starts |
| **Starter** | $5/month  | No cold starts, better for APIs    |
| **Pro**     | $20/month | Team features, priority support    |

**Typical API usage**: $3-8/month (within free tier!)

## üîó Useful Commands

```bash
# Project management
railway init              # Initialize project
railway link              # Link to existing project
railway status            # Check deployment status
railway open              # Open in browser

# Deployment
railway up                # Deploy current directory
railway up --detach       # Deploy in background

# Monitoring
railway logs              # View logs
railway logs --follow     # Stream logs

# Variables
railway variables         # List all variables
railway variables set KEY=VALUE  # Set variable

# Database
railway run <command>     # Run command with Railway env
railway connect postgres  # Connect to PostgreSQL CLI
```

## üìñ Additional Resources

- [Full Deployment Guide](../railway_deployment.md) - Comprehensive documentation
- [Quick Start Guide](../railway_quickstart.md) - 5-minute setup
- [Railway Docs](https://docs.railway.app) - Official documentation
- [Railway Discord](https://discord.gg/railway) - Community support
- [Rust on Railway](https://docs.railway.app/guides/rust) - Language-specific guide

## üéâ Next Steps

1. **Deploy**: Choose a deployment method above
2. **Set Variables**: Configure environment variables
3. **Add Database**: Provision PostgreSQL service
4. **Run Migrations**: Apply database schema
5. **Test**: Verify `/health` endpoint works
6. **Monitor**: Check logs and metrics
7. **Custom Domain**: Add your domain (optional)
8. **CI/CD**: Set up GitHub Actions (optional)

---

**Questions?** Open an issue or check the [full documentation](../railway_deployment.md).

**Ready to deploy?** Choose your preferred method and follow the steps!
