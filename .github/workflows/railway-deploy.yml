name: Deploy to Railway

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Job 1: Lint and Test
  # ============================================
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting
        run: cargo fmt -- --check

      - name: Run Clippy linter
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --verbose

      - name: Build project
        run: cargo build --release --verbose

  # ============================================
  # Job 2: Deploy to Railway (Production)
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --detach
          echo "url=https://your-production-url.railway.app" >> $GITHUB_OUTPUT

      - name: Deployment notification
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to production"
          echo "üîó URL: ${{ steps.deploy.outputs.url }}"

  # ============================================
  # Job 3: Deploy to Railway (Staging)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'

    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Staging
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
        run: |
          railway up --detach
          echo "url=https://your-staging-url.railway.app" >> $GITHUB_OUTPUT

      - name: Deployment notification
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to staging"
          echo "üîó URL: ${{ steps.deploy.outputs.url }}"

  # ============================================
  # Job 4: Health Check (Production)
  # ============================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://your-production-url.railway.app/health)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Health check passed (HTTP $response)"
          else
            echo "‚ùå Health check failed (HTTP $response)"
            exit 1
          fi
